pipeline {
    agent { label 'dotnetcore' }
    environment {
        DOTNET_CLI_HOME = '/home/jenkins'
    }
    options { 
        buildDiscarder(logRotator(numToKeepStr: '5'))
        timeout(time: 1, unit: 'HOURS')
    }
    stages {
        stage ('Get Latest Code') {
            steps {
                git url: 'https://github.com/encontact/enki.common.git'
            }
        }
        stage('Build') {
            steps {
                echo 'Building..'
                echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
                sh 'dotnet build -c Release'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing..'
                sh 'dotnet test test\enki.common.core.test\enki.common.core.test.csproj'
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying....'
                sh 'dotnet publish -c Release -o out/Release/'
                // sh './build.sh --target="Zip"'
            }
        }
        stage('Package') {
            when {
                branch 'master'  
            }
            steps {
                echo 'Deploying....'
                sh 'dotnet pack -o out/Release/'
            }
        }
    }
    post {
        success {
            archiveArtifacts 'out/Release/enki.common.zip'
            //notifyBuild(String buildStatus = 'SUCCESSFUL')
            echo 'Build concluido com sucesso.'
        }
        failure {
            echo 'Erro ao processar o build.'
            //notifyBuild(String buildStatus = 'FAIL')
            //mail to: "${params.recipients}", subject: "${params.subject}", body: "${params.body}"
        }
    }
}
